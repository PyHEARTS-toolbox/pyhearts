# R-Peak Detection and Cycle Epoching

## R-Peak Detection

R-peak detection was performed using a two-pass, prominence-based algorithm implemented with `scipy.signal.find_peaks`. Before peak detection, signals were preprocessed with a bandpass filter (0.5–40 Hz, 2nd-order Butterworth, zero-phase forward–backward filtering) to reduce baseline wander and high-frequency noise. Optional notch filtering was applied at regional mains interference frequencies (50 Hz or 60 Hz) when specified in the configuration.

Prominence thresholds were set adaptively using a two-stage approach. First, a training phase analyzed the initial 1–3 seconds of each recording to separate signal peaks from noise. This phase identified peaks in the training window using prominence-based detection and computed two values: `signal_peak` (the highest prominence in the training window) and `noise_peak` (the highest prominence below 75% of the signal peak). A training threshold was then computed as `noise_peak + 0.25 × (signal_peak − noise_peak)`. Second, an adaptive threshold was computed as 2.5 times the standard deviation of the signal (lowered from 3.0σ based on QTDB benchmark analysis to improve recall while maintaining precision). The final prominence threshold used the more conservative of these two values, with safety checks to prevent thresholds that exceeded 80% of the maximum signal amplitude, in which case the threshold was reduced to 30% of the maximum signal amplitude.

In the first pass, a permissive refractory period was applied to exclude physiologically implausible peak intervals: 100 milliseconds for the default configuration, 120 milliseconds for the human preset, and 67 milliseconds for the mouse preset. These thresholds correspond to theoretical maximum heart rates of approximately 600 beats per minute (bpm) for the default configuration, 500 bpm for the human preset, and 900 bpm for the mouse preset. The human preset threshold exceeds typical maximum sinus rates observed during exertion (about 200–220 bpm), allowing a wide margin that helps reject noise while preserving true beats, including rare tachycardic episodes. The mouse threshold accounts for reported peak physiological rates under stress (around 700–800 bpm), with additional headroom for transient extremes.

In the second pass, a refined search was conducted using a dynamic refractory period equal to 50% of the estimated median RR interval (lowered from 55% for improved sensitivity). Before computing the median, RR intervals from the first pass were filtered to remove outliers using a median-based filter that retained intervals within 92–116% of the median. This filtering step removed physiologically implausible RR values that could skew the median estimate. RR estimates were then constrained to species-specific physiological ranges (30–240 bpm for the human preset, 40–900 bpm for the default configuration, and 300–1000 bpm for the mouse preset). These bounds reflect published limits on sinus rhythm and reduce the risk of artifactual RR values skewing cycle segmentation.

Following the two-pass detection, peaks were validated using QRS characteristic filtering to reject P-waves and T-waves that might have been detected as R-peaks. This validation assessed peak slope (maximum absolute derivative in an 80 ms window before the peak) and QRS width (full-width at half-maximum, FWHM) to ensure detected peaks exhibited QRS-like characteristics. Peaks were required to have a slope greater than 75% of the median QRS slope (with an absolute minimum of 0.01) and a width between 20–200 ms. Only peaks passing both the two-pass detection and QRS characteristic validation were retained for downstream analysis.

The algorithm also supported simultaneous dual-polarity detection, allowing it to handle mixed-polarity signals where some R-peaks are inverted and some are upright (e.g., due to lead placement or signal quality). This was achieved by detecting peaks in both the original signal and its inverted version, then merging and validating the results.

Note that PyHEARTS supports three R-peak detection methods, with the prominence-based approach serving as the default. Alternative methods include the Pan-Tompkins algorithm (Pan & Tompkins, 1985), which uses bandpass filtering (5–15 Hz), derivative computation, squaring, and moving window integration, and a bandpass energy-based method that detects peaks using derivative energy with 150 ms moving-average integration. We evaluated all three methods on the QTDB dataset (n=10 subjects, 8,136 ground truth peaks) and found that the prominence-based method provided the best balance between precision (75.3%) and recall (88.3%), with a median absolute timing error of 8.00 ms. While the bandpass energy method achieved higher recall (99.6%) and the Pan-Tompkins method achieved higher precision (80.5%) with better timing accuracy (4.00 ms), the prominence-based method's balanced performance and robust handling of variable signal quality across diverse recordings made it the default choice for this study.

## Cycle Epoching

Epoching and cycle screening were performed around each detected R peak. A symmetric window was extracted for each beat, with a half-width equal to half the average RR interval for that recording. This ensured full-cycle coverage centered on each R-wave, allowing capture of the complete PQRST complex within each epoch.

Each cycle was subjected to two quality checks before being retained for analysis. First, the beat had to correlate with the global average cycle template at ≥0.70 (lowered from 0.80 to retain more beats with morphological variation). The global template was computed as the mean of all extracted cycles, and correlation was calculated using Pearson's correlation coefficient. Second, the cycle's variance could not exceed six times that of the full trace (raised from five times to accommodate greater beat-to-beat variability). Cycles passing both thresholds were retained and indexed for downstream analysis. This two-stage filtering approach removed noisy or artifact-contaminated beats while preserving physiologically valid beats with natural morphological variation.

Per-cycle baseline and trend removal was then applied to each retained epoch. Each beat was corrected in two stages. A baseline offset was removed by subtracting the median voltage of the initial portion of the cycle, defined by a configurable window length (200 milliseconds for human signals, 100 milliseconds for murine signals). This window length (`detrend_window_ms`) was chosen to capture the baseline level before the P-wave onset while avoiding contamination from the QRS complex. Then, a linear trend was estimated by fitting a line between the first and last sample of the cycle using linear regression, and this trend was subtracted. The resulting detrended waveform and slope estimate (`cycle_trend`) were stored for each beat and served as the foundation for all subsequent steps, including peak localization and morphological fitting. This per-cycle detrending approach removed both DC offset and slow baseline drift that could affect peak detection and amplitude measurements, while preserving the high-frequency components essential for waveform morphology analysis.

